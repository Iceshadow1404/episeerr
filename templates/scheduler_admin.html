<!-- Create templates/scheduler_admin.html -->
{% extends "base.html" %}

{% block title %}Scheduler Admin - OCDarr{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock me-2"></i>Time-Based Cleanup Scheduler</h5>
            </div>
            <div class="card-body">
                <div id="scheduler-status">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading scheduler status...</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>Manual Actions</h6>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="forceCleanup()">
                            <i class="fas fa-play me-1"></i>Clean Shows Now
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="refreshStatus()">
                            <i class="fas fa-refresh me-1"></i>Refresh Status
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle me-2"></i>How It Works</h6>
            </div>
            <div class="card-body">
                <small>
                    <p><strong>Automatic Cleanup:</strong></p>
                    <ul>
                        <li>Runs every 6 hours by default</li>
                        <li>Checks all series with time-based rules</li>
                        <li>Deletes content based on inactivity/grace period timers</li>
                    </ul>
                    
                    <p><strong>Configuration:</strong></p>
                    <ul>
                        <li>Set <code>CLEANUP_INTERVAL_HOURS</code> in .env</li>
                        <li>Configure time-based rules in Rules section</li>
                        <li>Assign series to time-based rules</li>
                    </ul>
                    
                    <p><strong>⚠️ **USE AT YOUR OWN RISK** ⚠️</strong></p>
                    <ul>
                        <li>will permanently delete your media files!</li>
                        <li>Test with non-critical series first</li>
                        <li>Keep backups of important content</li>
                    </ul>
                </small>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6><i class="fas fa-chart-line me-2"></i>Recent Activity</h6>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <small class="text-muted">Loading recent cleanup activity...</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let schedulerStatusInterval;

function loadSchedulerStatus() {
    fetch('/api/scheduler-status')
        .then(response => response.json())
        .then(data => {
            updateSchedulerDisplay(data);
        })
        .catch(error => {
            console.error('Error loading scheduler status:', error);
            document.getElementById('scheduler-status').innerHTML = 
                '<div class="alert alert-danger">Failed to load scheduler status</div>';
        });
}

function updateSchedulerDisplay(status) {
    const statusDiv = document.getElementById('scheduler-status');
    
    let statusBadge, statusText;
    if (status.status === 'running') {
        statusBadge = '<span class="badge bg-success">Running</span>';
        statusText = 'Scheduler is active and monitoring for cleanup conditions.';
    } else {
        statusBadge = '<span class="badge bg-danger">Stopped</span>';
        statusText = 'Scheduler is not running. Cleanup must be performed manually.';
    }
    
    statusDiv.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Status: ${statusBadge}</h6>
                <p>${statusText}</p>
            </div>
            <div class="col-md-6">
                <table class="table table-sm table-dark">
                    <tr>
                        <td>Cleanup Interval:</td>
                        <td>${status.interval_hours || 'N/A'} hours</td>
                    </tr>
                    <tr>
                        <td>Last Cleanup:</td>
                        <td>${status.last_cleanup || 'Never'}</td>
                    </tr>
                    <tr>
                        <td>Next Cleanup:</td>
                        <td>${status.next_cleanup || 'Unknown'}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;
}

function forceCleanup() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
    button.disabled = true;
    
    fetch('/api/force-cleanup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            ocdarrBanner.show('Manual cleanup started successfully', 'success');
            setTimeout(refreshStatus, 2000); // Refresh status after 2 seconds
        } else {
            ocdarrBanner.show('Failed to start cleanup: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        ocdarrBanner.show('Failed to start cleanup', 'error');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function refreshStatus() {
    loadSchedulerStatus();
    ocdarrBanner.show('Status refreshed', 'info', true, 2000);
}

function loadRecentActivity() {
    // This could fetch recent cleanup logs
    fetch('/api/recent-cleanup-activity')
        .then(response => response.json())
        .then(data => {
            const activityDiv = document.getElementById('recent-activity');
            if (data.activities && data.activities.length > 0) {
                let html = '<ul class="list-unstyled">';
                data.activities.slice(0, 5).forEach(activity => {
                    html += `<li><small>${activity.timestamp}: ${activity.description}</small></li>`;
                });
                html += '</ul>';
                activityDiv.innerHTML = html;
            } else {
                activityDiv.innerHTML = '<small class="text-muted">No recent activity</small>';
            }
        })
        .catch(error => {
            document.getElementById('recent-activity').innerHTML = 
                '<small class="text-muted">Unable to load recent activity</small>';
        });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSchedulerStatus();
    loadRecentActivity();
    
    // Refresh status every 30 seconds
    schedulerStatusInterval = setInterval(loadSchedulerStatus, 30000);
});

// Cleanup interval when leaving page
window.addEventListener('beforeunload', function() {
    if (schedulerStatusInterval) {
        clearInterval(schedulerStatusInterval);
    }
});
</script>
{% endblock %}